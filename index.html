<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Security+ Study Dashboard</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <script>
    // Check login
    const currentUser = localStorage.getItem("securityplus_user");
    if(!currentUser){
      window.location.href = "login.html";
    }
  </script>

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="brand">
      <div class="logo">
        <svg viewBox="0 0 24 24" width="22" height="22">
          <circle cx="12" cy="8" r="4" fill="#eaf0fa"/>
          <path d="M4 20a8 8 0 0 1 16 0" fill="#eaf0fa"/>
        </svg>
      </div>
      <h1>Security+ Dashboard</h1>
    </div>

    <div class="profile">
      <div class="name" id="userName"></div>
      <div class="role">Security+ Candidate</div>
      <button class="btn" id="logoutBtn" style="margin-top:8px;width:100%;justify-content:center;">Logout</button>
    </div>

    <nav class="nav">
      <a class="active" href="index.html">
        <svg viewBox="0 0 24 24"><path d="M12 3l9 7h-3v9h-5v-6H11v6H6v-9H3z"/></svg>
        Overview
      </a>
      <a href="chapters.html">
        <svg viewBox="0 0 24 24"><path d="M4 6h16v2H4zm0 5h16v2H4zm0 5h10v2H4z"/></svg>
        Chapters
      </a>
      <a href="flashcards.html">
        <svg viewBox="0 0 24 24"><path d="M4 6h12a2 2 0 0 1 2 2v10H6a2 2 0 0 1-2-2z"/><path d="M8 4h12a2 2 0 0 1 2 2v10h-2V6H8z"/></svg>
        Flashcards
      </a>
      <a href="search.html">
        <svg viewBox="0 0 24 24"><path d="M21 21l-4.35-4.35"/><circle cx="10" cy="10" r="7" stroke="#eaf0fa" stroke-width="2" fill="none"/></svg>
        Search
      </a>
    </nav>
  </aside>

  <!-- Main -->
  <main class="main">
    <div class="top">
      <h2>Dashboard</h2>
    </div>

    <div class="grid">
      <!-- KPIs -->
      <div class="col-12">
        <div class="kpis">
          <div class="kpi">
            <div class="label">Today</div>
            <div class="value" id="kpi-today">0</div>
          </div>
          <div class="kpi">
            <div class="label">Studied (All Time)</div>
            <div class="value" id="kpi-studied">0</div>
          </div>
          <div class="kpi">
            <div class="label">Total Terms</div>
            <div class="value" id="kpi-total">0</div>
          </div>
          <div class="kpi">
            <div class="label">Completion</div>
            <div class="value" id="kpi-completion">0%</div>
          </div>
        </div>
      </div>

      <!-- Bar chart -->
      <div class="col-8">
        <div class="card">
          <h3 class="section-title">Progress by Chapter</h3>
          <canvas id="progressChart" height="140"></canvas>
        </div>
      </div>

      <!-- Doughnut ring -->
      <div class="col-4">
        <div class="card">
          <h3 class="section-title">Overall Completion</h3>
          <div class="ring">
            <canvas id="ringChart" width="220" height="220"></canvas>
          </div>
          <div class="small" id="ringLabel" style="text-align:center;margin-top:6px">0% complete</div>
        </div>
      </div>

      <!-- Quick actions -->
      <div class="col-12">
        <div class="card">
          <h3 class="section-title">Quick Actions</h3>
          <div style="display:flex; gap:10px; flex-wrap:wrap">
            <a class="btn primary" href="flashcards.html">Start Flashcards</a>
            <a class="btn" href="chapters.html">Browse Chapters</a>
            <a class="btn" href="search.html">Open Search</a>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script type="module">
    import { loadAllData, summarizeByChapter, buildProgressChart } from './script.js';

    const user = localStorage.getItem("securityplus_user") || "Guest";
    document.getElementById("userName").textContent = user;

    // Logout
    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.removeItem("securityplus_user");
      window.location.href = "login.html";
    });

    let ALL_ITEMS = [];

    function updateKPIs(items){
      const studied = items.filter(it => localStorage.getItem(`securityplus_${user}_studied::${it.Name}`) === 'true').length;
      const total = items.length;
      const pct = total ? Math.round((studied/total)*100) : 0;
      document.getElementById('kpi-studied').textContent = studied;
      document.getElementById('kpi-total').textContent = total;
      document.getElementById('kpi-completion').textContent = pct + '%';
      document.getElementById('kpi-today').textContent = 0;
      return { studied, total, pct };
    }

    function buildRing(ctx, pct){
      return new Chart(ctx, {
        type:'doughnut',
        data:{
          labels:['Complete','Remaining'],
          datasets:[{
            data:[pct, 100-pct],
            backgroundColor:['#fca311','#e5e7eb']
          }]
        },
        options:{
          cutout:'70%',
          plugins:{ legend:{ display:false } }
        }
      });
    }

    (async function init(){
      ALL_ITEMS = await loadAllData();
      const { pct } = updateKPIs(ALL_ITEMS);
      const summary = summarizeByChapter(ALL_ITEMS);

      const barctx = document.getElementById('progressChart').getContext('2d');
      buildProgressChart(barctx, summary);

      const rctx = document.getElementById('ringChart').getContext('2d');
      buildRing(rctx, pct);
      document.getElementById('ringLabel').textContent = pct + '% complete';
    })();
  </script>
</body>
</html>
